# トランザクション

- ひとまとまりで実行されるべき一つ以上の更新処理の集まり
- データベースにおけるデータ更新処理の確定、取り消しなどを管理する事ができる
- COMMIT : 処理の確定
- ROLLBACK : 処理の取り消し

## ACID 特性

DBMS のトランザクションにおいて守るべき４つの約束事。標準規格で定められている。

- Atomicity： 原始性
  - All or nothing。　全ての処理が行われるか（COMMIT）、もしくは全ての処理が行われないかのみ（ROLLBACK）
  - トランザクションの一部だけ成功、失敗している状態は存在しないということ。
- Consistency : 一貫性(整合性)
  - 違法な SQL はロールバックされたと判断されて、実行することはできない。
  - 違法な SQL とは NOT NULL などの制約に従っていないということ
- Isolation : 独立性
  - トランザクション同士がお互いに干渉しないことを保証する
  - トランザクション同士が入れ子になる事がない
  - トランザクションによる変更は終了時まで別のトランザクションから隠蔽
  - コミットされるまでは他のトランザクションから追加されたレコードは見えない
- Durability : 永続性
  - 耐久性、トランザクションが終了したら、その時点でデータの状態が保存されることを保証する品質
  - システム障害が発生してデータが失われたとしてデータベースはなんらかの手段でこれを復旧させる手段を持たねばいけない
    - トランザクションの実行記録を保存しておき、障害が起きたときはこのログを使って障害前の状態に復旧する

## Transaction とは

「テーブルのデータに対する更新の単位」
「データベースに対する一つ以上の更新をまとめて呼ぶときの名称」
「複数の操作を意味的にわかりやすく人まとまりにしたもの」
「ワンセットで行われるべき更新の集合」

## Transaction を作るには

トランザクション開始文とトランザクション開始文で DML を囲う

```
トランザクション開始文
DML文 ①;
DML文 ②;
DML文 ③;
...
トランザクション終了文（COMMIT または ROLLBACK）
```

### トランザクション開始文

- 暗黙に開始されることが標準 SQL 規格で決められている
  - 実際にはデータベースに接続した時点でトランザクションが開始と同義なので不要だったりする
  - オラクルは最初の SQL が実行された時点がトランザクションの開始地点である
  - 暗黙のトランザクションが開始された場合、トランザクションの区切りは下記２つ
    1. １つの SQL 文で１つのトランザクションというルールが適応される（自動コミットモード）
    2. ユーザーが COMMIT or ROLLBACK を実行するまでが１つのトランザクションとみなされる
  - どの DBMS でも、どちらのモードも選択可能。ディフォルトは自動コミットモード
- 開始文としては標準で定義されていなく、DBMS により異なる
- トランザクションの開始は曖昧でも大丈夫だが、コミットはしっかり確認

- SQL Server, PostgreSQL
  `BEGIN TRANSACTION`

- MySQL
  `START TRANSACTION`

### トランザクションの終了文

#### `COMMIT`

- トランザクションに含まれていた更新を全て反映してトランザクションを終了するコマンド
- コミットしたらトランザクション開始前には戻れない

#### `ROLLBACK`

- トランザクションに含まれていた処理による変更を全て破棄
- 「保存せずに終了」と同義
- データベースの状態はトランザクションを開始する前に戻る
