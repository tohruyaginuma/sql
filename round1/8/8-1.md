# ウインドウ関数　（OLAP 関数）

- ウテーブルをウインドウという部分集合にカットしてその中で順序づけを行うもの。
- ランキング、連番生成など通常の集約関数ではできない高度な操作
- PARTITION BY, ORDER BY のキーワードを理解することが重要
- SELECT 句でのみ利用できる
  - ウインドウ関数が WHERE や GROUP BY の処理が終わった結果に対して作用するため
- Online Analytical Processing（OLAP）
  - データベースを使ってリアルタイムにデータ分析を行う処理のこと
  - 使用分析、財務諸表作成、計画作成
  - 一部の DBMS しか持っていない
- ウインドウ関数として使える関数。下記をウインドウ関数と呼ぶ
  - 集約関数
    - SUM, AVG, COUNT, MAX, MIN
  - ウインドウ専用関数
    - RANK
      - ランキングを算出。同順位があった場合、後続の順位が飛ぶ
    - DENSE_RANK
      - ランキングを算出。同順位があった場合でも、後続の準備はとばない
    - ROW_NUMBER
      - 指定した SQL 順に、一意な連番を付与する。エクセルの列番号みたいな感じで使えそう
    - 他にもあるが、標準 SQL では上記
    - 常に実行に()をつける。引数はないので常に空。

## RANK 関数

- レコードのランキングを算出する関数

```sql
SELECT shohin_mei, shohin_bunrui, hanbai_tanka,
RANK () OVER (
PARTITION BY shohin_bunrui ORDER BY hanbai_tanka
) AS ranking
FROM Shohin;
```

- PARTITION BY

  - 順位をつける対象の範囲を設定
  - これによって区切られたレコードの集合をウインドウと呼ぶ
  - Window: 窓ではなく、範囲を表す
  - オプショナルである。つけない場合、出力結果で一つのウインドウとみなされる
    ```sql
    SELECT shohin_mei, shohin_bunrui, hanbai_tanka,
    RANK () OVER (
    ORDER BY hanbai_tanka
    ) AS ranking
    FROM Shohin;
    ```

- ORDER BY
  - どんな順序で順位をつけるか
- ウインドウ専用関数の比較

```sql
SELECT shohin_mei, shohin_bunrui, hanbai_tanka,
RANK () OVER (ORDER BY hanbai_tanka) AS ranking,
DENSE_RANK () OVER (ORDER BY hanbai_tanka) AS dense_ranking,
ROW_NUMBER () OVER (ORDER BY hanbai_tanka) AS row_num
FROM Shohin;
```

## 集約関数をウインドウ関数として使う

### 累計

```sql
SELECT shohin_id, shohin_mei, hanbai_tanka, SUM(hanbai_tanka) OVER (ORDER BY shohin_id) AS current_sum FROM Shohin;
```

### 平均を出す

```sql
SELECT shohin_id, shohin_mei, hanbai_tanka, AVG(hanbai_tanka) OVER (ORDER BY shohin_id) AS current_sum FROM Shohin;
```

## フレーム -- オプションの集計範囲

- ウインドウ中で集計範囲をさらに細かく指定するオプション機能
- Moving average（移動平均）

```sql
-- 直近３レコードの平均
SELECT shohin_id, shohin_mei, hanbai_tanka, AVG(hanbai_tanka) OVER (
ORDER BY shohin_id ROWS 2 PRECEDING) AS moving_avg
FROM Shohin;
```

- ROWS 2 PRECEDING: 2 行前までの（直近 3 行）
  - ROWS: 行
  - PRECEDING: 前の
- FOLLOWING: 後ろの

```sql
-- Current recordを中心に3行表示
SELECT shohin_id, shohin_mei, hanbai_tanka, AVG(hanbai_tanka) OVER(ORDER BY shohin_id
ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING) AS moving_avg FROM Shohin;
```

## ２つの ORDER BY

- OVER 句内の ORDER BY はあくまでウインドウ関数がどういう順序で研鑽するかを決めるだけの役割

```sql
-- 下記のsqlもpsqlではオーダーされてるが、標準SQLでは順序は保証されていない
SELECT shohin_mei, shohin_bunrui, hanbai_tanka, RANK () OVER (ORDER BY hanbai_tanka) AS ranking FROM Shohin;

-- ORDER BYが二つ使われているが、用途が違う
SELECT shohin_mei, shohin_bunrui, hanbai_tanka, RANK () OVER (ORDER BY hanbai_tanka) AS ranking FROM Shohin ORDER BY ranking;
```
