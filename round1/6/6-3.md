# CASE 式

- SQL の中でもトップクラスに重要な機能
- いわゆる IF（SWITCH） 文
- ２種類ある
  - 単純 CASE 式
  - 検索 CASE 式
    - ここではこちらを解説
- ELSE は省略できるが、わかりやすさのためにしないこと
  - 省略した場合 ELSE NULL とみなされる
- END は省略できない
- SELECT 文の結果を組み替えることができる
- 他 DBMS の IF, DECODE などは標準 SQL ではないので、使わないのがベター
- 式なので、式をかける場所ならどこでもかける
- 構文
  `CASE WHEN ... THEN ... ELSE ... END`

- WHEN
  - いわゆる IF
- THEN
  - WHEN が TRUE なら実行
- ELSE
  - DEFAULT CASE
- END
  - CASE の終了

```sql
-- ||は文字列を結合する関数
SELECT shohin_mei,
CASE WHEN shohin_bunrui = '衣服'
THEN 'A: ' || shohin_bunrui
WHEN shohin_bunrui = '事務用品'
THEN 'B: ' || shohin_bunrui
WHEN shohin_bunrui = 'キッチン用品'
THEN 'C: ' || shohin_bunrui
ELSE NULL
END AS abc_shohin_bunrui
FROM Shohin;

-- GROUP BYによる分類 列で出力になる
SELECT shohin_bunrui,
SUM(hanbai_tanka) AS sum_tanka
FROM Shohin
GROUP BY shohin_bunrui;

-- CASE複数列にまとめて1行で出力できる
SELECT SUM(
    CASE WHEN shohin_bunrui = '衣服'
    THEN hanbai_tanka
    ELSE 0
    END) AS sum_tanka_ihuku,
    SUM(
    CASE WHEN shohin_bunrui = 'キッチン用品'
    THEN hanbai_tanka
    ELSE 0
    END) AS sum_tanka_kitchen,
    SUM(
    CASE WHEN shohin_bunrui = '事務用品'
    THEN hanbai_tanka
    ELSE 0
    END) AS sum_tanka_office
FROM Shohin;
```

## 単純 CASE 式

- 実務では基本的に検索 CASE を利用する
- 記述が簡潔なことが利点だが、条件が限定的
- Switch の仕組みに近い感じ

```sql
-- 検索CASE
SELECT shohin_mei,
CASE WHEN shohin_bunrui = '衣服' THEN 'A: ' || shohin_bunrui
WHEN shohin_bunrui = '事務用品' THEN 'A: ' || shohin_bunrui
WHEN shohin_bunrui = 'キッチン用品' THEN 'A: ' || shohin_bunrui
ELSE NULL
END AS abc_shohin_bunrui
FROM Shohin;

-- 単純CASE
SELECT shohin_mei,
CASE shohin_bunrui
WHEN '衣服' THEN 'A: ' || shohin_bunrui
WHEN '事務用品' THEN 'B: ' || shohin_bunrui
WHEN 'キッチン用品' THEN 'C: ' || shohin_bunrui
ELSE NULL
END AS abc_shohin_bunrui
FROM Shohin;
```

```sql
-- 6.1
-- 1. shiire_tankaが、500, 2800, 5000以外のレコードが表示される
-- 2. 何も表示されない

-- 6.2

SELECT
COUNT(CASE WHEN hanbai_tanka < 1000 THEN hanbai_tanka ELSE NULL END) AS low_price,
COUNT(CASE WHEN hanbai_tanka BETWEEN 1001 AND 3000 THEN hanbai_tanka ELSE NULL END) AS mid_price,
COUNT(CASE WHEN hanbai_tanka > 3001 THEN hanbai_tanka ELSE NULL END) AS high_price
FROM Shohin;
```
