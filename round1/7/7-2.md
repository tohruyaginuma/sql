# 結合 -- JOIN

- 基本は下記の結合
  - 内部結合
  - 外部結合
- Diarect や古い書き方を使わず、標準 SQL で書くこと

## 結合とは

- 別のテーブルから列を持ってきて列を増やす操作

## INNER JOIN -- 内部結合

- FROM 句に複数のテーブルを書く INNER JOIN というキーワードをつけて
- AS で別名をつけなくてもいいが、SQL が長くなりがちなのでつけるのが慣習
- ON： 結合条件を記載
  - FROM と WHERE の間に書くこと
- SELECT Table.列名 と慣習で書く。Table は省略できるが書いた方が親切
- 2 つのテーブル両方に存在している情報だけを表示する
- テーブルの内部だけから情報を持ってくる結合が内部結合と呼ばれる

```sql
SELECT TS.tenpo_id, TS.tenpo_mei, TS.shohin_id, S.shohin_mei, S.hanbai_tanka
FROM TanpoShohin AS TS INNER JOIN Shohin AS S
ON TS.shohin_id = S.shohin_id
WHERE TS.tenpo_id = '000A';


```

## OUTER JOIN -- 外部結合

- 片方のテーブルの情報が全て出力される
- どちらかのテーブルに存在していれば表示する
- 元のテーブルにない、外部のテーブルから持ってくるという意味で外部結合と呼ばれる
- どちらのテーブルをマスターとみなすかが大事
  - マスターに指定されたデータがすべて出てくることになる
  - それを指定するのが LEFT, RIGHT キーワード
  - LEFT なら左側をマスタに、RIGHT なら右側をマスタに
  - どちらも使っていい、どちらかというと LEFT の方が多いとのこと

```sql
SELECT TS.tenpo_id, TS.tenpo_mei, S.shohin_id, S.shohin_mei, S.hanbai_tanka
FROM TanpoShohin AS TS RIGHT OUTER JOIN Shohin AS S
ON TS.shohin_id = S.shohin_id;
```

## 3 つ以上のテーブルを使った結合

```sql
-- DDL
CREATE TABLE ZaikoShohin
(
  souko_id  CHAR(4) NOT NULL,
  shohin_id CHAR(4) NOT NULL,
  zaiko_suryo INTEGER NOT NULL,
  PRIMARY KEY (souko_id, shohin_id)
);

-- DML
BEGIN TRANSACTION;

INSERT INTO ZaikoShohin (souko_id, shohin_id, zaiko_suryo) VALUES ('S001',	'0001',	0);
INSERT INTO ZaikoShohin (souko_id, shohin_id, zaiko_suryo) VALUES ('S001',	'0002',	120);
INSERT INTO ZaikoShohin (souko_id, shohin_id, zaiko_suryo) VALUES ('S001',	'0003',	200);
INSERT INTO ZaikoShohin (souko_id, shohin_id, zaiko_suryo) VALUES ('S001',	'0004',	3);
INSERT INTO ZaikoShohin (souko_id, shohin_id, zaiko_suryo) VALUES ('S001',	'0005',	0);
INSERT INTO ZaikoShohin (souko_id, shohin_id, zaiko_suryo) VALUES ('S001',	'0006',	99);
INSERT INTO ZaikoShohin (souko_id, shohin_id, zaiko_suryo) VALUES ('S001',	'0007',	999);
INSERT INTO ZaikoShohin (souko_id, shohin_id, zaiko_suryo) VALUES ('S001',	'0008',	200);
INSERT INTO ZaikoShohin (souko_id, shohin_id, zaiko_suryo) VALUES ('S002',	'0001',	10);
INSERT INTO ZaikoShohin (souko_id, shohin_id, zaiko_suryo) VALUES ('S002',	'0002',	25);
INSERT INTO ZaikoShohin (souko_id, shohin_id, zaiko_suryo) VALUES ('S002',	'0003',	34);
INSERT INTO ZaikoShohin (souko_id, shohin_id, zaiko_suryo) VALUES ('S002',	'0004',	19);
INSERT INTO ZaikoShohin (souko_id, shohin_id, zaiko_suryo) VALUES ('S002',	'0005',	99);
INSERT INTO ZaikoShohin (souko_id, shohin_id, zaiko_suryo) VALUES ('S002',	'0006',	0);
INSERT INTO ZaikoShohin (souko_id, shohin_id, zaiko_suryo) VALUES ('S002',	'0007',	0);
INSERT INTO ZaikoShohin (souko_id, shohin_id, zaiko_suryo) VALUES ('S002',	'0008',	18);

COMMIT;

```

```sql
SELECT TS.tenpo_id, TS.tenpo_mei, TS.shohin_id, S.shohin_mei, S.hanbai_tanka, ZS.zaiko_suryo
FROM TanpoShohin AS TS INNER JOIN Shohin AS S
ON TS.shohin_id = S.shohin_id
INNER JOIN ZaikoShohin AS ZS
ON TS.shohin_id = ZS.shohin_id
WHERE ZS.souko_id = 'S001';
```

## CROSS JOIN -- 直積

- 実務で使うことはない
- 各テーブルのすべての組み合わせを作るコマンド -２つのテーブルの行数の掛け算になる

```sql
SELECT TS.tenpo_id, TS.tenpo_mei, TS.shohin_id, S.shohin_mei
FROM TanpoShohin AS TS CROSS JOIN Shohin AS S;
```

## 結合の方言と古い構文

- 古い構文や方言は使わないこと。ただ読めるようにはしておくこと。

## 練習問題

```sql
SELECT COALESCE(TS.tenpo_id, '不明'), COALESCE(TS.tenpo_mei, '不明'), S.shohin_id, S.shohin_mei, S.hanbai_tanka
FROM TanpoShohin AS TS RIGHT OUTER JOIN Shohin AS S
ON TS.shohin_id = S.shohin_id;
```
