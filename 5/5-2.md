# Sub Query

- ビュー定義の SELECT 文をそのまま FROM 句に持ち込んだもの
- 使い捨てのビュー、SELECT 文の実行後に削除される
- FROM()内の SELECT 文をサブクエリと呼ぶ
- 入れ子に制限はないので、深くもできる。が避けるべき、パフォーマンス、可動性の観点から
- サブクエリ名定義の AS は省略もできる
- スカラサブクエリは WHERE に限らず、どこでもかける（定数や列名を書くことのできる場所全て）

## 実行順

```sql
SELECT shohin_bunrui, cnt_shohin
FROM (SELECT shohin_bunrui, COUNT(*) AS cnt_shohin
FROM Shohin
GROUP BY shohin_bunrui) AS ShohinSum;
```

1. FROM 句内の SELECT 文（サブクエリ）が実行される
2. ① の結果に対して、外側の SELECT 文が実行される

## Scalar Subquery

- 戻り値が単一の値になるサブクエリのこと
- 戻り値が comparable になるので、そのように使うことが可能
- Scalar：単一の

- 平均販売単価のより高い商品を選択

```sql
SELECT shohin_id, shohin_mei, hanbai_tanka
FROM Shohin
WHERE hanbai_tanka > (
    SELECT AVG(hanbai_tanka) FROM Shohin
);
```

- WHERE に直接集約関数は使えないのでこういった形になる。
  - なぜならレコーズの集約前だから
- 実行順はもちろんサブクエリから、その後その戻り値を評価する

## SELECT でスカラサブクエリを使う

```sql
SELECT shohin_id,
    shohin_mei,
    hanbai_tanka,
    (SELECT AVG(hanbai_tanka) FROM Shohin) AS avg_tanka
FROM Shohin;
```

## HAVING 句でスカラサブクエリを使う

```sql
SELECT shohin_bunrui, AVG(hanbai_tanka)
FROM Shohin
GROUP BY shohin_bunrui
HAVING AVG(hanbai_tanka) > (
    SELECT AVG(hanbai_tanka)  FROM Shohin
);
```

## スカラサブクエリの注意点

- 絶対にサブクエリが複数行返さないようにすること
  - 複数行返す時点でスカラサブクエリではなく、普通のサブクエリ
- SELECT 句などに書くこともできなくなる
