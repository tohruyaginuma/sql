# 相関サブクエリ Correlated Subquery

- 外側のクエリ（親クエリ）の行ごとに再評価されるサブクエリのこと
- 小分けにしたグループ内での比較をするときに使う
- テーブル全体ではなくテーブルの一部のレコード集合に限定した比較をしたい場合に使う
- 相関サブクエリを使用するとき、バインドすると表現される

```sql
SELECT shohin_bunrui, shohin_mei, hanbai_tanka
FROM Shohin AS S1
WHERE hanbai_tanka > (
    SELECT  AVG(hanbai_tanka)
    FROM    Shohin AS S2
    -- ここが大事。結合条件を指定
    -- 同じ名前なので、別名でわける
    WHERE   S1.shohin_bunrui = S2.shohin_bunrui
    GROUP BY shohin_bunrui
);
```

- サブクエリとクエリをバインドし、スカラ値ではなく列ごとの値を返して評価する
- サブクエリ内で作られた相関名はそのサブクエリ内でしか使えない

## 練習問題

```
-- 5.1
CREATE VIEW VIEWRenshu5_1 AS
SELECT shohin_mei, hanbai_tanka, torokubi
FROM Shohin
WHERE hanbai_tanka >= 1000
AND torokubi = '2009-09-20';

SELECT * FROM ViewRenshu5_1;

-- 5.2
-- NG
-- 元の単一のテーブルの条件を満たしていてかつ、WHERE条件を満たしているか
INSERT INTO ViewRenshu5_1 VALUES ('ナイフ', 300, '2009-11-02');

-- 5.3
SELECT shohin_id, shohin_mei, shohin_bunrui, hanbai_tanka, (SELECT AVG(hanbai_tanka) FROM Shohin) AS hanbai_tanaka_all
FROM Shohin
ORDER BY shohin_id;

-- 5.4
SELECT shohin_id, shohin_mei, shohin_bunrui, hanbai_tanka, (
    SELECT AVG(hanbai_tanka)
    FROM Shohin AS S2
    WHERE S1.shohin_bunrui = S2.shohin_bunrui
) AS avg_habai_tanka
FROM Shohin AS S1
ORDER BY shohin_id;

```
