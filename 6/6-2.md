# 述語

- 戻り値が真理値になる関数のこと
  - `真理値：TRUE/FALSE/UNKNOWN`
- LIKE
  - 前方一致
  - 中間一致
  - 後方一致
- BETWEEN
- NULL
- IN, EXISTS

## Predicate(述語)

- 比較述語
  `-, <, >, <>`

### LIKE

- 部分一致検索を行う
  - 前方一致：名前の通り、最初に一致するか
    ```sql
    SELECT * FROM SampleLike WHERE strcol LIKE 'ddd%';
    ```
  - 中間一致：文字中で一致するか
    ```sql
    SELECT * FROM SampleLike WHERE strcol LIKE '%ddd%';
    ```
  - 後方一致：最後に一致するか
    ```sql
    SELECT * FROM SampleLike WHERE strcol LIKE '%ddd';
    SELECT * FROM SampleLike WHERE strcol LIKE 'abc__';
    SELECT * FROM SampleLike WHERE strcol LIKE 'abc___';
    ```
- パターンマッチング：
  - 文字列の中に含まれる規則に基づいて検索すること
- `%`：%で始まる 0 文字以上の文字列。ワイルドカードになってる
- `_`：一文字分のワイルドカード

```sql
-- DDL
CREATE TABLE SampleLike(strcol VARCHAR(255). NOT NULL, PRIMARY KEY (strcol));

-- DML
BEGIN TRANSACTION;
INSERT INTO SampleLike ( strcol ) VALUES ('abcddd');
INSERT INTO SampleLike ( strcol ) VALUES ('dddabc');
INSERT INTO SampleLike ( strcol ) VALUES ('abdddc');
INSERT INTO SampleLike ( strcol ) VALUES ('abcdd');
INSERT INTO SampleLike ( strcol ) VALUES ('ddabc');
INSERT INTO SampleLike ( strcol ) VALUES ('abddc');
COMMIT;
```

### BETWEEN

- 範囲検索
- 特徴として「含む」検索である。
- 下記の例では 100 から 1000 を検索

```sql
SELECT shohin_mei, hanbai_tanka
FROM Shohin
WHERE hanbai_tanka BETWEEN 100 AND 1000;
```

- 「含まない」検索の場合は下記のように対応
  - 101 - 999

```sql
SELECT shohin_mei, hanbai_tanka
FROM Shohin
WHERE hanbai_tanka > 100
AND hanbai_tanka < 1000;
```

### IS NULL

```sql
SELECT shohin_mei, shiire_tanka
FROM Shohin
WHERE shiire_tanka IS NULL;

-- try to use COALESCE
SELECT shohin_mei, COALESCE(shiire_tanka, -1)
FROM Shohin
WHERE shiire_tanka IS NULL;
```

### IS NOT NULL

```sql
SELECT shohin_mei, shiire_tanka
FROM Shohin
WHERE shiire_tanka IS NOT NULL;
```

### IN

- 与えたリストに含まれているかどうか
- NULL を選択することはできない

```sql
SELECT shohin_mei, shiire_tanka
FROM Shohin
WHERE shiire_tanka IN (320, 500, 5000);

-- NOTで否定することも可能
SELECT shohin_mei, shiire_tanka
FROM Shohin
WHERE shiire_tanka NOT IN (320, 500, 5000);
```

#### IN 述語の引数にサブクエリを指定

- IN は引数にサブクエリを指定することができる
- IN はテーブルを引数に指定することができる
- IN はビューを指定することができる

```sql
-- DDL
CREATE TABLE TanpoShohin (
    tenpo_id CHAR(4) NOT NULL,
    tenpo_mei VARCHAR(255),
    shohin_id CHAR(4) NOT NULL,
    suryo INTEGER,
    PRIMARY KEY (tenpo_id)
);

ALTER TABLE TanpoShohin
DROP CONSTRAINT tanposhohin_pkey;

ALTER TABLE TanpoShohin
ADD PRIMARY KEY (tenpo_id, shohin_id);

ALTER TABLE TanpoShohin
ALTER COLUMN tenpo_mei TYPE VARCHAR(200);

ALTER TABLE TanpoShohin
ALTER COLUMN tenpo_mei SET NOT NULL;

ALTER TABLE TanpoShohin
ALTER COLUMN suryo SET NOT NULL;

-- DML
BEGIN TRANSACTION;
INSERT INTO TanpoShohin (tenpo_id, tenpo_mei, shohin_id, suryo) VALUES ('000A', '東京', '0001', 30);
INSERT INTO TanpoShohin (tenpo_id, tenpo_mei, shohin_id, suryo) VALUES ('000A', '東京', '0002', 50);
INSERT INTO TanpoShohin (tenpo_id, tenpo_mei, shohin_id, suryo) VALUES ('000A', '東京', '0003', 15);
INSERT INTO TanpoShohin (tenpo_id, tenpo_mei, shohin_id, suryo) VALUES ('000B', '名古屋', '0002', 30);
INSERT INTO TanpoShohin (tenpo_id, tenpo_mei, shohin_id, suryo) VALUES ('000B', '名古屋', '0003', 120);
INSERT INTO TanpoShohin (tenpo_id, tenpo_mei, shohin_id, suryo) VALUES ('000B', '名古屋', '0004', 20);
INSERT INTO TanpoShohin (tenpo_id, tenpo_mei, shohin_id, suryo) VALUES ('000B', '名古屋', '0006', 10);
INSERT INTO TanpoShohin (tenpo_id, tenpo_mei, shohin_id, suryo) VALUES ('000B', '名古屋', '0007', 40);
INSERT INTO TanpoShohin (tenpo_id, tenpo_mei, shohin_id, suryo) VALUES ('000C', '大阪', '0003', 20);
INSERT INTO TanpoShohin (tenpo_id, tenpo_mei, shohin_id, suryo) VALUES ('000C', '大阪', '0004', 50);
INSERT INTO TanpoShohin (tenpo_id, tenpo_mei, shohin_id, suryo) VALUES ('000C', '大阪', '0006', 90);
INSERT INTO TanpoShohin (tenpo_id, tenpo_mei, shohin_id, suryo) VALUES ('000C', '大阪', '0007', 70);
INSERT INTO TanpoShohin (tenpo_id, tenpo_mei, shohin_id, suryo) VALUES ('000D', '福岡', '0001', 100);

COMMIT;
```

```sql
-- IN + SUBQUERY
SELECT shohin_id
FROM TanpoShohin
WHERE tenpo_id = '000C';

SELECT shohin_id, shohin_mei, hanbai_tanka
FROM Shohin
WHERE shohin_id IN (
    SELECT shohin_id
    FROM TanpoShohin
    WHERE tenpo_id = '000C'
);

-- NOT IN SUB QUERY
SELECT shohin_id, shohin_mei, hanbai_tanka
FROM Shohin
WHERE shohin_id NOT IN (
    SELECT shohin_id
    FROM TanpoShohin
    WHERE tenpo_id = '000A'
);
```

### EXISTS

- ある条件に合致するレコードの存在有無を調べること
  - TRUE | FALSE を返す
- 引数を一つだけ取り、その引数はサブクエリである
- 常に相関サブクエリを引数に取る

```sql
SELECT shohin_mei, hanbai_tanka
FROM Shohin AS S
WHERE EXISTS (
    SELECT *
    FROM TanpoShohin AS TS
    WHERE TS.tenpo_id = '000C'
    AND TS.shohin_id = S.shohin_id
);
```
