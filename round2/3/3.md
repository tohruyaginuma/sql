# 3-1

```sql
SELECT COUNT(*) FROM Shohin;

SELECT COUNT(shiire_tanka) FROM Shohin;


-- 重複値を省いてカウント
SELECT COUNT(DISTINCT shohin_bunrui) FROM Shohin;

-- COUNTの実効値の重複を削除
SELECT DISTINCT COUNT(shohin_bunrui) FROM Shohin;
```

- COUNT の特殊な仕様
  - COUNT(\*)→NULL をカウントする
    - 単にテーブルの行数を数える
  - COUNT(row_name)→NULL をカウントしない
    - 値のある列を数える

```sql
SELECT SUM(hanbai_tanka)
FROM Shohin;

SELECT SUM(hanbai_tanka), SUM(shiire_tanka)
FROM Shohin;
SELECT AVG(hanbai_tanka), AVG(shiire_tanka)
FROM Shohin;

SELECT MAX(hanbai_tanka), MIN(shiire_tanka)
FROM Shohin;

SELECT SUM(hanbai_tanka), SUM(DISTINCT hanbai_tanka)
FROM Shohin;
```

- SUM、AVG 関数において NULL は 0 という扱いになる
- DISTINCT は集約関数全般につけることができる

# 3-2

```sql
SELECT shohin_bunrui, COUNT(*)
FROM Shohin
GROUP BY shohin_bunrui;

SELECT shiire_tanka, COUNT(*)
FROM Shohin
GROUP BY shiire_tanka;

SELECT shiire_tanka, COUNT(*)
FROM Shohin
WHERE shohin_bunrui = '衣服'
GROUP BY shiire_tanka;

SELECT shohin_mei, shiire_tanka, COUNT(*)
FROM Shohin
GROUP BY shiire_tanka;
```

- 集約キーに NULL が含まれる場合、NULL グループとして扱われる
- 実行順序
  - FROM → WHERE → GROUP BY → SELECT
- GROUP BY に指定したキー以外の項目を SELECT に入れることはできない。
  - なぜなら GROUP BY によって絞り込まれた結果に対して、他の項目が複数パターンある場合があるから
  - １セルには複数の値を表示できない。
  - 解決方法として、代表値を決めたり、サブクエリを使用したりする

```sql
-- postgreでは動くが、標準　SQLでは動かない。実行順に注意
SELECT shohin_bunrui AS sb, COUNT(*)
FROM Shohin
GROUP BY sb;

-- 集約関数をかけるのはSELECTとHAVING, ORDER BYのみ。下記は不正
SELECT shohin_bunrui, COUNT(*)
FROM Shohin
WHERE COUNT(*) = 2
GROUP BY shohin_bunrui;
```

# 3-3

- HAVING グループ化したカラムを絞り込む

```sql
-- 下記のように書く
SELECT shohin_bunrui, COUNT(*)
FROM Shohin
GROUP BY shohin_bunrui
HAVING COUNT(*) = 2;

SELECT shohin_bunrui, AVG(hanbai_tanka)
FROM Shohin
GROUP BY shohin_bunrui
HAVING AVG(hanbai_tanka) >= 2500;

-- WHERE は最初に実行され、絞り込みを行うので、パフォーマンスのために使えるときは積極的に利用したい。
SELECT shohin_bunrui, COUNT(*)
FROM Shohin
GROUP BY shohin_bunrui
HAVING shohin_bunrui = '衣服';

SELECT shohin_bunrui, COUNT(*)
FROM Shohin
WHERE shohin_bunrui = '衣服'
GROUP BY shohin_bunrui;
```

# 3-4 ORDER BY

```sql
SELECT shohin_id, shohin_mei, hanbai_tanka, shiire_tanka
FROM Shohin
ORDER BY hanbai_tanka;

SELECT shohin_id, shohin_mei, hanbai_tanka, shiire_tanka
FROM Shohin
ORDER BY hanbai_tanka DESC;

--  複数指定できる。販売単価が評価されて、商品IDが評価される
SELECT shohin_id, shohin_mei, hanbai_tanka, shiire_tanka
FROM Shohin
ORDER BY hanbai_tanka, shohin_id;

SELECT shohin_id AS id, shohin_mei, hanbai_tanka AS ht, shiire_tanka
FROM Shohin
ORDER BY ht, id;
```

- ソートキーに NULL が含まれている場合、先頭か末尾にまとめられる。
- どちらになるかは DBMS によって違う

- 実行順
  - SQL は英語の実行順。プログラムではなく。
  - FROM WHERE, GROUP BY HAVING, SELECT ORDER BY;

```sql
SELECT shohin_mei, hanbai_tanka, shiire_tanka
FROM Shohin
ORDER BY shohin_id;

SELECT shohin_bunrui, COUNT(*)
FROM Shohin
GROUP BY shohin_bunrui
ORDER BY COUNT(*) DESC;
```

- ORDER BY は列番号が使えるが、使わないこと
- 列番号は SELECT 句で指定したカラムの左から 1,2,3 ... と数えた番号
- 列番号は deprecate

```sql
SELECT shohin_id, shohin_mei, hanbai_tanka, shiire_tanka
FROM Shohin
ORDER BY hanbai_tanka DESC, shohin_id;

SELECT shohin_id, shohin_mei, hanbai_tanka, shiire_tanka
FROM Shohin
ORDER BY 3 DESC, 1;
```

```sql
SELECT shohin_bunrui, SUM(hanbai_tanka), SUM(shiire_tanka) FROM Shohin GROUP BY shohin_bunrui
HAVING SUM(hanbai_tanka) > SUM(shiire_tanka) * 1.5;


SELECT *
FROM Shohin
ORDER BY torokubi DESC;

INSERT INTO Shohin SELECT * FROM Shohin;

CREATE TABLE ShohinSaeki
(
  shohin_id CHAR(4) NOT NULL,
  shohin_mei VARCHAR(100) NOT NULL,
  hanbai_tanka INTEGER,
  shiire_tanka INTEGER,
  saeki INTEGER,
  PRIMARY KEY (shohin_id)
);

ALTER TABLE ShohinSaeki RENAME shiiretanka TO shiire_tanka;

INSERT INTO ShohinSaeki (shohin_id, shohin_mei, hanbai_tanka, shiire_tanka, saeki) SELECT shohin_id, shohin_mei, hanbai_tanka, shiire_tanka, hanbai_tanka - shiire_tanka FROM Shohin;

UPDATE ShohinSaeki
SET hanbai_tanka = 3000,
saeki = 3000 - shiire_tanka
WHERE shohin_id = '0003';
```
