# GROUPING 演算子

- ３種類ある

  - ROLLUP
  - CUBE
  - GROUPING SETS

- 合計行の出力

```sql
-- GROUP BYだと分類は可能だが、合計は求めることができない
SELECT shohin_bunrui, SUM(hanbai_tanka)
FROM Shohin
GROUP BY shohin_bunrui;

/*
- 合計を求める。合計行と集約結果を個別に求めてUNIONALLでくっつけることで
- しかし、SQLコストは高く、見た目も冗長
*/
SELECT '合計' AS shohin_bunrui, SUM(hanbai_tanka)
FROM Shohin
UNION ALL
SELECT shohin_bunrui, SUM(hanbai_tanka)
FROM Shohin
GROUP BY shohin_bunrui;
```

## ROLLUP -- 合計とチャンクごとの小計を一度に求める

```sql
SELECT shohin_bunrui, SUM(hanbai_tanka) AS sum_tanka
FROM Shohin
GROUP BY ROLLUP(shohin_bunrui);
```

- GROUP BY 句に記述する
- 集約キーの組み合わせが異なる結果を一度に計算する
- 上記は二つの組み合わせの集約を一度に計算している
  - GROUP BY ()
    - 全体の合計行のレコードを生み出している
  - GROUP BY (shohin_bunrui)
- 超集合行：GROUP BY では作られない合計の行

```sql
SELECT shohin_bunrui, torokubi, SUM(hanbai_tanka) AS sum_tanka
FROM Shohin
GROUP BY ROLLUP(shohin_bunrui, torokubi)
ORDER BY shohin_bunrui;
```

上記は下記を UNION ALL した結果となってる。

- GROUP BY()
- GROUP BY(shohin_bunrui)
- GROUP BY(shohin_bunrui, torokubi)

## GROUPING

```sql
-- 超集合のNULLを1で表示できる。それ以外は0
SELECT GROUPING(shohin_bunrui) AS shohin_bunrui, GROUPING(torokubi) AS torokubi, SUM(hanbai_tanka) AS sum_tanka
FROM Shohin
GROUP BY ROLLUP(shohin_bunrui, torokubi);

-- それをトリガーにしてラベルをつける
SELECT
CASE WHEN GROUPING(shohin_bunrui) = 1
THEN '商品分類 合計'
ELSE shohin_bunrui
END AS shohin_bunrui,
CASE WHEN GROUPING(torokubi) = 1
THEN '登録日  合計'
ELSE CAST(torokubi AS VARCHAR(16))
END AS torokubi,
SUM(hanbai_tanka) AS sum_tanka
FROM Shohin
GROUP BY ROLLUP(shohin_bunrui, torokubi);

-- ↑CASEの出力の型は一致していないといけない。なので変換してる
-- DATE to VARCHAR
```

## CABE -- データで積み木を作る

- 考えられるすべての組み合わせを出す。
- 全体の合計、各項目の小計すべて

```sql
SELECT CASE WHEN GROUPING(shohin_bunrui) = 1
THEN '商品分類 合計'
ELSE shohin_bunrui END AS shohin_bunrui,
CASE WHEN GROUPING(torokubi) = 1
THEN '登録日 合計'
ELSE CAST(torokubi AS VARCHAR(16)) END AS torokubi,
SUM(hanbai_tanka) AS sum_tanka
FROM Shohin
GROUP BY CUBE(shohin_bunrui, torokubi);
```

- CUBE は ROLLUP に対して何行かを追加する形になる。
- 集約キーとして torokubi だけを使ったケースが追加されている

## GROUPING SETS -- 欲しい積み木だけ取得する

- ROLLUP, CUBE でも止めた結果の一部のレコードだけを求めれば良い場合に使う
- CUBE では考えられるすべての組み合わせが出力される。その中からいくつかを絵選びたい場合などに使える
- 条件を個別で指定して抜き出す

```sql
SELECT CASE WHEN GROUPING(shohin_bunrui) = 1
THEN '商品分類 合計'
ELSE shohin_bunrui END AS shohin_bunrui,
CASE WHEN GROUPING(torokubi) = 1
THEN '登録日 合計'
ELSE CAST(torokubi AS VARCHAR(16)) END AS torokubi,
SUM(hanbai_tanka) AS sum_tanka
FROM Shohin
GROUP BY GROUPING SETS (shohin_bunrui, torokubi);
```

## 練習問題

```sql
SELECT shohin_id, shohin_mei, hanbai_tanka, MAX(hanbai_tanka) OVER (ORDER BY shohin_id) AS current_max_tanka
FROM Shohin;
```

```sql
SELECT shohin_mei, torokubi, SUM(hanbai_tanka) OVER (ORDER BY torokubi)
FROM Shohin;
```

- UNION ALL はソートしない分、UNION よりパフォーマンスが良い
